#!/usr/bin/env node

const metrics = require('commander');
const clientCollector = require('./lib/clientMetrics');
const serverCollector = require('./lib/serverMetrics');
const bundleCollector = require('./lib/bundleMetrics');
const table = require('markdown-table');

metrics
    .version('1.7.0')
    .option('--chromiumPath [chromiumPath]', 'Chromium path for puppeteer')
    .option('--ignoreHTTPSErrors', 'Ignore HTTPS errors with puppeteer when true')
    .option('--control [control]', 'Specify the URL to be used as the control to compare against')
    .option('--pr [pr]', 'Specify the URL to be used to compare the control to')
    .parse(process.argv);

if (!process.argv.slice(2).length) {
    metrics.outputHelp();
}

const tableHeader = [['Metric',
                      'Desktop Control',
                      'Desktop PR',
                      'Desktop ∆',
                      'Mobile Control',
                      'Mobile PR',
                      'Mobile ∆']];

const metricsCollectors = [clientCollector, serverCollector, bundleCollector];

async function printMarkdownTable(controlUrl, prUrl, options) {
    let formattedTables = metricsCollectors.map(async (collector) => {
        const control = await collector.collect(controlUrl, options);
        const pr = await collector.collect(prUrl, options);

        return collector.formatTable(control, pr);
    });

    formattedTables = await Promise.all(formattedTables);

    console.log(table([].concat.apply(tableHeader, formattedTables)));
}

printMarkdownTable(metrics.control,
                   metrics.pr,
                   {executablePath: metrics.chromiumPath,
                    ignoreHTTPSErrors: metrics.ignoreHTTPSErrors});
